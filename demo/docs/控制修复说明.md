# 🔧 控制算法修复说明

## 问题诊断

### 1. ❌ 符号错误导致转圈
- **原因**: CTE计算使用了错误的公式，导致左右转向反了
- **表现**: 平均航向误差98.96°，实时显示CTE:-2.03m, θ:-168.8°
- **影响**: 车辆在转弯时会持续转圈，无法正常跟踪路径

### 2. ❌ 车辆显示不直观
- **原因**: 使用圆形表示车辆，无法看清朝向
- **影响**: 难以判断车辆实际运动状态

---

## ✅ 修复内容

### 1. **CTE计算修正** (app.js)
```javascript
// ❌ 旧方法 - 使用距离和角度差
const cte = distToTarget * Math.sin(angleToTarget - vehicle.theta);

// ✅ 新方法 - 使用向量叉积
const vx = Math.cos(vehicle.theta);
const vy = Math.sin(vehicle.theta);
const cte = dx * vy - dy * vx;  // 车辆右侧为正，左侧为负
```

**说明**: 
- 使用向量叉积 `(车头向量 × 目标向量)` 计算横向偏差
- **正值**: 目标在车辆右侧 → 需要向左转（负角速度）
- **负值**: 目标在车辆左侧 → 需要向右转（正角速度）

### 2. **控制逻辑优化** (app.js)
```javascript
// CTE控制：右偏(正CTE)需要左转(负omega)
const steeringControl = -(pid.kp * cte + pid.ki * pid.integral + pid.kd * derivative);

// 航向控制：需要右转(正headingError)输出正omega
const headingGain = 0.8;  // 从0.5提高到0.8
const headingControl = headingGain * headingError;

// 总角速度（逆时针为正）
let omega = steeringControl + headingControl;

// 放宽角速度限制
const maxOmega = 2.5; // 从2.0提高到2.5 rad/s (≈143°/s)
```

**改进点**:
- ✅ 增加航向增益 (0.5→0.8) 提高转向响应
- ✅ 增大角速度限制 (2.0→2.5 rad/s) 允许更快转向
- ✅ 添加详细调试日志显示符号和单位

### 3. **车辆可视化升级** (canvas.js)
```javascript
// ❌ 旧方式 - 简单圆形
ctx.arc(0, 0, this.cellSize * 0.6, 0, Math.PI * 2);

// ✅ 新方式 - 矩形车身 + 车头指示
const length = this.cellSize * 1.2; // 车长
const width = this.cellSize * 0.7;   // 车宽

// 车身主体
ctx.fillRect(-length/4, -width/2, length, width);

// 橙色三角形车头（指示朝向）
ctx.fillStyle = '#FFA500';
ctx.moveTo(length*0.75, 0);
ctx.lineTo(length*0.5, -width/2);
ctx.lineTo(length*0.5, width/2);

// 黑色车轮
ctx.fillRect(...); // 左右两个车轮
```

**效果**:
- 🚗 矩形车身清晰显示车辆尺寸
- 🔶 橙色三角形车头指示前进方向
- ⚫ 两侧车轮增强真实感
- ⬛ 车身轮廓线框增强立体感

### 4. **PID预设参数** (index.html + app.js)

添加了4组预设参数，用于演示不同控制策略：

| 预设 | Kp | Ki | Kd | Speed | 特点 |
|------|----|----|-------|-------|------|
| **保守型** ⭐ | 0.6 | 0.01 | 0.4 | 0.6 m/s | 最稳定，不易振荡 |
| **平衡型** | 1.0 | 0.03 | 0.5 | 0.8 m/s | 响应与稳定兼顾 |
| **激进型** | 1.5 | 0.05 | 0.3 | 1.0 m/s | 快速响应，可能振荡 |
| **缓慢型** | 0.8 | 0.02 | 0.6 | 0.4 m/s | 低速高精度跟踪 |

**使用方法**:
1. 在"轨迹控制"面板顶部选择预设
2. 参数会自动填入（也可手动微调）
3. 点击"开始PID闭环控制"测试效果

### 5. **调试信息增强**
```javascript
console.log(`控制: CTE=${cte.toFixed(2)}m (右+/左-), 
             航向误差=${(headingError*180/Math.PI).toFixed(1)}°, 
             角速度=${(omega*180/Math.PI).toFixed(1)}°/s`);
```

**实时显示**:
- 控制步数面板: `535 | CTE:-2.03m | θ:-168.8°`
- CTE正负含义明确: 右+ / 左-
- 角度转换为度数便于理解

---

## 📊 测试对比

### 修复前症状
```
平均CTE: 0.7896 m (大)
最大CTE: 3.9964 m (非常大)
平均航向误差: 98.96° (接近180°，完全错误)
控制步数: 535 | CTE:-2.03m | θ:-168.8°
现象: 车辆转圈，无法跟踪路径
```

### 修复后预期
```
平均CTE: < 0.3 m (小)
最大CTE: < 1.5 m (可接受)
平均航向误差: < 15° (正常范围)
控制步数: 300-400 | CTE:±0.2m | θ:±5°
现象: 平滑跟踪路径，适当转向
```

---

## 🧪 测试步骤

### 1. 刷新浏览器
```bash
按 Ctrl + F5 强制刷新
```

### 2. 选择简单场景测试
- 推荐: **open.json** (开阔空间，路径简单)
- 点击"开始规划"生成路径

### 3. 测试不同预设
```
A. 保守型 (推荐首选)
   - 选择"保守型"预设
   - 点击"开始PID闭环控制"
   - 观察: 应该平滑跟踪，无振荡
   - CTE应保持在±0.5m内

B. 激进型 (对比测试)
   - 选择"激进型"预设  
   - 重新规划并控制
   - 观察: 响应更快，可能略有振荡
   - 适合简单路径

C. 缓慢型 (精确跟踪)
   - 选择"缓慢型"预设
   - 观察: 跟踪最精确，但速度慢
   - CTE应最小
```

### 4. 观察关键指标

**控制台输出**:
```javascript
控制: CTE=0.15m (右+/左-), 航向误差=3.2°, 角速度=12.5°/s
✅ 正常: CTE在±0.5m内，角速度合理

控制: CTE=-2.03m (右+/左-), 航向误差=-168.8°, 角速度=143°/s
❌ 异常: CTE过大，角速度达到上限
```

**界面显示**:
- 车辆应显示为矩形+橙色车头
- 绿色实时轨迹应紧贴蓝色规划路径
- CTE图表应在±1m范围内波动

### 5. 测试碰撞检测
- 在路径上绘制障碍物
- 车辆接近时应显示: "⚠️ 车辆碰撞！控制已停止"
- 控制自动停止

---

## 🔍 符号规则总结

### CTE (Cross Track Error)
```
         目标点
           ↑
           |
    -------+------- 路径
           |
           | CTE = +0.5m (右侧)
           |
        🚗 (车辆在路径右侧)
        
需要: 左转 (负角速度)
控制: steeringControl = -Kp * CTE = 负值 ✓
```

```
        🚗 (车辆在路径左侧)
           |
           | CTE = -0.5m (左侧)
           |
    -------+------- 路径
           ↑
         目标点
        
需要: 右转 (正角速度)
控制: steeringControl = -Kp * CTE = 正值 ✓
```

### 航向误差 (Heading Error)
```
目标朝向: 90° (正北)
当前朝向: 45° (东北)
航向误差: 90° - 45° = 45° (需要逆时针转)

需要: 逆时针转 (正角速度)
控制: headingControl = Kh * headingError = 正值 ✓
```

### 角速度 (Omega)
```
正值: 逆时针转向 (向左转)
负值: 顺时针转向 (向右转)
限制: ±2.5 rad/s (≈±143°/s)
```

---

## 💡 参数调优建议

### 如果车辆振荡
- ⬇️ 降低 Kp (减少比例增益)
- ⬇️ 降低速度 (给控制更多时间)
- ⬆️ 增加 Kd (增强阻尼)

### 如果跟踪不准
- ⬆️ 增加 Kp (增强纠偏能力)
- ⬆️ 增加 Ki (消除稳态误差)
- ⬇️ 降低速度 (提高精度)

### 如果转弯不够快
- ⬆️ 增加航向增益 (headingGain)
- ⬆️ 增加前视距离 (lookahead)
- 检查角速度是否达到上限

---

## 📝 技术细节

### 车辆运动学模型
```javascript
// 自行车模型 (Bicycle Model)
x_dot = v * cos(theta)
y_dot = v * sin(theta)
theta_dot = omega

dt = 0.05s (50ms控制周期)
v = 固定速度 (0.4-1.0 m/s)
omega = PID控制输出 (±2.5 rad/s)
```

### 碰撞检测
```javascript
// 检测车辆周围0.5m半径
checkRadius = 0.5m
sampleInterval = 0.25m

for (angle in 0 to 2π, step 0.5):
    for (r in 0 to checkRadius, step sampleInterval):
        checkPoint = vehicle.position + r * [cos(angle), sin(angle)]
        if (hasObstacle(checkPoint)):
            return COLLISION
```

### 控制频率
- 控制周期: 50ms (20Hz)
- 图表更新: 每5步 (0.25s)
- 统计更新: 实时 (50ms)

---

## ✅ 修复清单

- [x] 修正CTE计算符号（向量叉积法）
- [x] 优化航向控制增益（0.5→0.8）
- [x] 增大角速度限制（2.0→2.5 rad/s）
- [x] 车辆可视化改为矩形车身
- [x] 添加橙色三角形车头指示
- [x] 添加车轮显示
- [x] 创建4组PID预设参数
- [x] 实现预设参数自动切换
- [x] 增强调试日志（符号标注）
- [x] 实时显示CTE和航向误差
- [x] 更新默认参数为保守型

---

## 🎯 预期效果

1. **车辆不再转圈**: CTE符号正确，转向方向准确
2. **可视化清晰**: 矩形车身+橙色车头，朝向一目了然
3. **参数易调**: 4组预设覆盖不同场景，快速对比效果
4. **调试方便**: 实时显示关键数据，符号标注清晰

测试愉快！🚀
